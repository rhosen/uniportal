@page
@model UniPortal.Pages.Classes.ScheduleModel
@{
    ViewData["Title"] = "Class Schedule Management";
    Layout = "_AdminLayout";
}

<div class="container my-4">
    <h2 class="mb-4">📅 Schedule Management</h2>

    <!-- Search Box -->
    <form method="get" class="mb-2">
        <div class="input-group">
            <input type="text" name="PageInfo.SearchTerm" value="@Model.PageInfo.SearchTerm" class="form-control" placeholder="Search by course or classroom..." />
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>



    <!-- Add New Schedule -->
    <form method="post" class="mb-4">


        @if (Model.Schedule.ScheduleId != Guid.Empty)
        {
            <input type="hidden" asp-for="Schedule.ScheduleId" />
        }


        <!-- Multi-day selection for new schedule -->
        <div class="mb-3 py-2 d-flex align-items-center">
            <label class="form-label me-3 mb-0">Days:</label>
            @for (int i = 1; i <= 7; i++)
            {
                var dayShort = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.AbbreviatedDayNames[i - 1];
                <div class="form-check form-check-inline me-2 mb-0">
                    <input class="form-check-input"
                           type="checkbox"
                           id="day@(i)"
                           name="Schedule.SelectedDays"
                           value="@(i)"
                           @(Model.Schedule.SelectedDays.Contains(i) ? "checked" : "") />
                    <label class="form-check-label" for="day@(i)">@dayShort</label>
                </div>
            }
        </div>

        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <select asp-for="Schedule.SelectedCourseId" class="form-select" required>
                    <option value="">-- Select Course --</option>
                    @foreach (var course in Model.Courses)
                    {
                        <option value="@course.Id">@course.Name</option>
                    }
                </select>
            </div>
            <div class="col-auto">
                <select asp-for="Schedule.SelectedClassroomId" class="form-select" required>
                    <option value="">-- Select Classroom --</option>
                    @foreach (var room in Model.Classrooms)
                    {
                        <option value="@room.Id">@room.Name</option>
                    }
                </select>
            </div>
            <div class="col-auto">
                <input asp-for="Schedule.StartTime" type="time" class="form-control" required />
            </div>
            <div class="col-auto">
                <input asp-for="Schedule.EndTime" type="time" class="form-control" required />
            </div>
            <div class="col-auto">
                <button type="submit"
                        asp-page-handler="@(Model.Schedule.ScheduleId == Guid.Empty ? "Create" : "SaveEdit")"
                        class="btn btn-success">
                    @(Model.Schedule.ScheduleId == Guid.Empty ? "Add" : "Save Changes")
                </button>
            </div>
        </div>
    </form>

    <!-- Existing Schedules Table -->
    <table class="table table-striped">
        <thead class="table-dark">
            <tr>
                <th>Course</th>
                <th>Classroom</th>
                <th>Days</th>
                <th>Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var sched in Model.Schedules)
            {
                <tr>
                    <td>@sched.CourseName</td>
                    <td>@sched.ClassroomName</td>
                    <td>@string.Join(" ", sched.Entries.Select(e => e.DayName))</td>
                    <td>
                        @sched.Entries.FirstOrDefault()?.StartTime.ToString("hh:mm tt") -
                        @sched.Entries.FirstOrDefault()?.EndTime.ToString("hh:mm tt")
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <form method="post" class="mb-0">
                                <input type="hidden" name="scheduleId" value="@sched.ScheduleId" />
                                <button type="submit" asp-page-handler="Edit" class="btn btn-sm btn-primary">Edit</button>
                            </form>
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="showDeleteModal('@sched.ScheduleId', '@Url.Page("", "", new { handler = "Delete" }, null)')">
                                Delete
                            </button>
                        </div>

                    </td>
                </tr>
            }
        </tbody>
    </table>


    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            <li class="page-item @(Model.PageInfo.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="?PageInfo.CurrentPage=@(Model.PageInfo.CurrentPage - 1)&PageInfo.SearchTerm=@Model.PageInfo.SearchTerm">Previous</a>
            </li>
            @for (int i = 1; i <= Model.PageInfo.TotalPages; i++)
            {
                <li class="page-item @(i == Model.PageInfo.CurrentPage ? "active" : "")">
                    <a class="page-link" href="?PageInfo.CurrentPage=@i&PageInfo.SearchTerm=@Model.PageInfo.SearchTerm">@i</a>
                </li>
            }
            <li class="page-item @(Model.PageInfo.CurrentPage == Model.PageInfo.TotalPages ? "disabled" : "")">
                <a class="page-link" href="?PageInfo.CurrentPage=@(Model.PageInfo.CurrentPage + 1)&PageInfo.SearchTerm=@Model.PageInfo.SearchTerm">Next</a>
            </li>
        </ul>
    </nav>
</div>
